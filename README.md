# pull-request-reviewer-assignment-service

Микросервис для автоматического назначения ревьюверов на Pull Request'ы.

## Быстрый старт

```bash
# Сборка и запуск
make build
make run

# Или одной командой
make dev
```

Сервис будет доступен на http://localhost:8080

Все команды по работе с серисом можно посмотреть в [Makefile](./Makefile) или командой ```make help```

## API Endpoints

#### Основные эндпоинты
* ```GET /health``` - Health check
* ```POST /team/add``` - Создание команды
* ```GET /team/get?team_name=...``` - Получение команды
* ```POST /users/setIsActive``` - Изменение активности пользователя
* ```POST /pullRequest/create``` - Создание PR с автоназначением ревьюверов
* ```POST /pullRequest/merge``` - Мерж PR
* ```POST /pullRequest/reassign``` - Переназначение ревьювера
* ```GET /users/getReview?user_id=...``` - PR пользователя для ревью

#### Дополнительные эндпоинты
* ```GET /stats/review-assignments``` - Статистика назначений
* ```POST /users/bulk-deactivate``` - Массовая деактивация пользователей

## Собираемая статистика по эндпоинту ```GET /stats/review-assignments```

1. Общая статистика

    ```total_assignments``` - общее количество всех назначений на код-ревью в системе

2. Статистика по пользователям
    
    ```assignments_by_user``` - детальная статистика по каждому активному пользователю:

        user_id - идентификатор пользователя

        username - имя пользователя

        assignment_count - количество назначений на ревью

3. Статистика по Pull Requests

    ```assignments_by_pr``` - статистика по каждому Pull Request:

        pr_id - идентификатор PR

        pr_name - название PR

        assignment_count - количество назначенных ревьюверов

4. Топ ревьюверов

    ```top_reviewers``` - список топ-5 самых активных ревьюверов (отсортирован по убыванию количества назначений)

## Результаты нагрузочного тестирования
#### __Требования ТЗ:__

* RPS: 5 запросов/сек
* Время ответа: 95% запросов < 300ms
* Успешность: 99.9% успешных запросов

#### __Фактические результаты:__
* RPS: 11.95 запросов/сек 
* Время ответа P95: 3.42 ms
* Успешность: 99.87% (почти соответствует)

## Структура БД
* ```teams``` - Команды
* ```users``` - Пользователи
* ```pull_requests``` - Pull Request'ы
* ```pr_reviewers``` - Назначенные ревьюверы

## E2E-Тестирование

Проект включает полноценное End-to-End тестирование, которое проверяет полный цикл работы системы:
```bash
# Полные E2E тесты
make test-e2e

# Быстрые E2E тесты
make test-e2e-fast

# Упрощенные E2E тесты
make test-e2e-simple

# Запуск E2E окружения для дебага
make e2e-env
```

Что проверяют E2E тесты:
* Создание команды с пользователями
* Создание PR с автоназначением ревьюверов
* Переназначение ревьюверов
* Мерж PR и проверка идемпотентности
* Массовая деактивация пользователей
* Получение статистики
* Обработка ошибок (несуществующие сущности, невалидные данные)

## Конфигурация линтера

Проект использует golangci-lint для статического анализа кода. Конфигурация включает:

#### Основные линтеры:
```gofmt``` - проверка форматирования кода

```goimports``` - организация импортов

```govet``` - статический анализ

```staticcheck``` - продвинутый статический анализ

```errcheck``` - проверка обработки ошибок

```gosec``` - проверка безопасности

#### Команды линтинга:
```bash
# Установка линтера
make setup-linter

# Полная проверка кода
make lint

# Автоисправление проблем
make lint-fix

# Проверка по слоям архитектуры
make lint-handlers    # HTTP обработчики
make lint-services    # Бизнес-логика
make lint-models      # Модели данных
make lint-repos       # Репозитории

# Быстрая проверка
make lint-fast

# Полная проверка стиля
make style
```

#### Особенности конфигурации:
* Настроены исключения для длинных HTTP обработчиков
* Оптимизированы настройки для бизнес-логики
* Учитывается архитектура проекта (handlers/services/repositories)
* Игнорируются ложные срабатывания для специфичных случаев

## Технический стек
* Язык: Go 1.21
* База данных: PostgreSQL 15
* Контейнеризация: Docker + Docker Compose
* Тестирование: k6 для нагрузочного тестирования
